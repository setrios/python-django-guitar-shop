{% extends "base.html" %}

{% block title %}Cart{% endblock title %}

{% block content %}
<h1 class="mb-4">
    Cart:
    $<span id="cart-subtotal">{{ cart.get_sub_total_price }}</span>
</h1>

<div>
    {% for cart_entry in cart.products %}
    <div class="card mb-4" id="card-product-{{forloop.counter}}">
        <div class="row g-0">
            <div class="col-md-4">
                <img src="{{ cart_entry.item.image.url }}" class="card-img-top" alt="{{ cart_entry.item.name }}"
                    style="height: 250px; object-fit: cover;">
            </div>
            <div class="col-md-8">
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="{{ cart_entry.item.get_absolute_url }}" class="text-decoration-none">{{ cart_entry.item.name }}</a>
                    </h5>
                    <p class="card-text text-muted">{{ cart_entry.quantity }} x ${{ cart_entry.item.price }}</p>
                    <p>
                        <button class="btn btn-outline-primary qty-btn" data-action="decrease"
                            data-item-id="{{ cart_entry.item.id }}">-</button>

                        <button class="btn btn-outline-primary qty-btn" data-action="increase"
                            data-item-id="{{ cart_entry.item.id }}">+</button>
                    </p>
                    <p class="card-text text-success">${{ cart_entry.item_total }}</p>
                    <p>
                    <form class="delete-from-cart-form"
                        data-action-url="{% url 'cart:delete_product' cart_entry.item.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="card-id" value="{{ forloop.counter }}">
                        {% comment %} <input type="hidden" name="item-type" value="product"> {% endcomment %}
                        <button type="submit" class="btn btn-outline-danger delete-btn">
                            Delete
                        </button>
                    </form>
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    <hr class="m-4">
    {% for cart_entry in cart.accessories %}
    <div class="card mb-4" id="card-accessory-{{forloop.counter}}">
        <div class="row g-0">
            <div class="col-md-4">
                <img src="{{ cart_entry.item.image.url }}" class="card-img-top" alt="{{ cart_entry.item.name }}"
                    style="height: 250px; object-fit: cover;">
            </div>
            <div class="col-md-8">
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="{{ cart_entry.item.get_absolute_url }}" class="text-decoration-none">{{ cart_entry.item.name }}</a>
                    </h5>
                    <p class="card-text text-muted">{{ cart_entry.quantity }} x ${{ cart_entry.item.price }}</p>
                    <p>
                        <button class="btn btn-outline-primary qty-btn" data-action="decrease"
                            data-item-id="{{ cart_entry.item.id }}">-</button>

                        <button class="btn btn-outline-primary qty-btn" data-action="increase"
                            data-item-id="{{ cart_entry.item.id }}">+</button>
                    </p>
                    <p class="card-text text-success">${{ cart_entry.item_total }}</p>
                    <p>
                    <form class="delete-from-cart-form"
                        data-action-url="{% url 'cart:delete_accessory' cart_entry.item.pk %}">
                        {% csrf_token %}
                        <input type="hidden" name="card-id" value="{{ forloop.counter }}">
                        {% comment %} <input type="hidden" name="item-type" value="accessory"> {% endcomment %}
                        <button type="submit" class="btn btn-outline-danger delete-btn">
                            Delete
                        </button>
                    </form>
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div>
    <a class="btn btn-success" href="{% url 'orders:checkout' %}">Checkout</a>
</div>

<!-- sending AJAX with vanilla JS -->
<script>
    const getCookie = (name) => {
        let cookieValue = null

        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';')

            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim()

                if (cookie.substring(0, name.length + 1) === `${name}=`) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
                    break
                }
            }
        }

        return cookieValue
    }

    const updateCartCount = (count) => {
        const cartCountElement = document.querySelector('.cart-count')

        if (cartCountElement) {
            cartCountElement.textContent = count

            // Add animation
            cartCountElement.classList.add('animate-bounce')
            setTimeout(() => {
                cartCountElement.classList.remove('animate-bounce')
            }, 500)
        }
    }

    const updateSubtotal = (subtotal) => {
        const subtotalElement = document.getElementById('cart-subtotal')
        if (subtotalElement) {
            subtotalElement.textContent = subtotal
        }
    }

    const removeCard = (elementId) => {
        const element = document.getElementById(`card-${elementId}`);
        if (element) {
            element.remove();
            console.log(`Element with ID "${elementId}" removed.`);
        }
        else {
            console.log(`Element with ID "${elementId}" not found.`);
        }
    }

    const handleDeleteFromCart = async (event) => {
        event.preventDefault();

        const form = event.currentTarget;
        const button = form.querySelector('.delete-btn');
        const cardId = form.querySelector('input[name="card-id"]').value;
        const url = form.dataset.actionUrl;

        button.disabled = true;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: new FormData(form),
            });

            const data = await response.json();

            if (response.ok && data.success) {
                removeCard(cardId)
                updateCartCount(data.cart_count)
                updateSubtotal(data.cart_total)

                location.reload() // do reload page
            }
            else {
                alert(data.error || 'Delete failed');
            }
        }
        catch (err) {
            console.error(err);
            alert('Server error');
        }
        finally {
            button.disabled = false;
        }
    };

    const handleQuantityUpdate = async (event) => {
        const btn = event.currentTarget
        const action = btn.dataset.action
        const itemId = btn.dataset.itemId

        btn.disabled = true

        const response = await fetch(`/cart/product/update/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                action: action
            })
        });

        const data = await response.json();

        if (response.ok && data.success) {
            updateCartCount(data.cart_count);
            updateSubtotal(data.cart_total);

            location.reload() // do reload page
        }
        else {
            alert(data.error || 'Update failed');
        }

        btn.disabled = false;
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.delete-from-cart-form').forEach(form => {
            form.addEventListener('submit', handleDeleteFromCart)
        })
        document.querySelectorAll('.qty-btn').forEach(btn => {
            btn.addEventListener('click', handleQuantityUpdate)
        })
    })
</script>
{% endblock content %}